<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#1a3a5c" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CCB Fichas" />
  <title>CCB Caieiras ‚Äì Fichas</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- Microsoft MSAL (OneDrive) -->
  <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>

  <style>
    :root {
      --navy: #1a3a5c;
      --navy-light: #234d7a;
      --gold: #c8922a;
      --gold-light: #e8b84b;
      --cream: #f8f4ee;
      --white: #ffffff;
      --gray-100: #f1ede7;
      --gray-200: #e0d9cf;
      --gray-400: #a89f92;
      --gray-600: #6b6258;
      --gray-800: #3d3630;
      --danger: #c0392b;
      --success: #27ae60;
      --shadow: 0 4px 24px rgba(26,58,92,0.13);
      --shadow-sm: 0 2px 8px rgba(26,58,92,0.09);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Source Sans 3', sans-serif;
      background: var(--cream);
      color: var(--gray-800);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
    #app { display: block; min-height: 100vh; }

    /* Header */
    .app-header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      color: var(--white);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .app-header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app-header .brand .cross {
      font-size: 24px;
      color: var(--gold);
    }

    .app-header .brand div h1 {
      font-family: 'Merriweather', serif;
      font-size: 14px;
      line-height: 1.2;
    }

    .app-header .brand div p {
      font-size: 10px;
      color: rgba(255,255,255,0.6);
      letter-spacing: 0.5px;
    }

    .header-actions { display: flex; gap: 8px; }

    .icon-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: var(--white);
      cursor: pointer;
      font-size: 18px;
      padding: 8px 10px;
      transition: background 0.2s;
    }

    .icon-btn:active { background: rgba(255,255,255,0.2); }

    /* Tab Nav */
    .tab-nav {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 61px;
      z-index: 99;
    }

    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--gray-400);
      cursor: pointer;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding: 12px 8px;
      text-align: center;
      transition: all 0.2s;
    }

    .tab-btn.active {
      border-bottom-color: var(--gold);
      color: var(--navy);
    }

    .tab-btn span { display: block; font-size: 18px; margin-bottom: 2px; }

    /* Content */
    .tab-content { display: none; padding: 20px 16px; }
    .tab-content.active { display: block; }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 16px;
    }

    .form-card-header {
      background: var(--navy);
      color: var(--white);
      font-family: 'Merriweather', serif;
      font-size: 13px;
      letter-spacing: 0.5px;
      padding: 12px 16px;
    }

    .form-card-body { padding: 16px; }

    /* Fields */
    .field { margin-bottom: 14px; }

    .field label {
      display: block;
      color: var(--gray-600);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.8px;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .field input[type="text"],
    .field input[type="number"],
    .field input[type="tel"],
    .field input[type="date"],
    .field select,
    .field textarea {
      width: 100%;
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      color: var(--gray-800);
      font-family: 'Source Sans 3', sans-serif;
      font-size: 14px;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      background: var(--white);
      border-color: var(--navy);
    }

    .field textarea { min-height: 70px; resize: vertical; }

    /* Row */
    .field-row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .field-row-3 { display: grid; gap: 12px; grid-template-columns: 1fr 1fr 1fr; }

    /* Checkboxes group */
    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      padding: 10px 12px;
      transition: all 0.2s;
      user-select: none;
    }

    .checkbox-item:has(input:checked) {
      background: #eaf2ff;
      border-color: var(--navy);
    }

    .checkbox-item input[type="checkbox"] {
      accent-color: var(--navy);
      cursor: pointer;
      height: 16px;
      width: 16px;
      flex-shrink: 0;
    }

    .checkbox-item span {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-800);
      line-height: 1.3;
    }

    /* Radio group */
    .radio-group { display: flex; gap: 10px; }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 7px;
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      flex: 1;
      justify-content: center;
      padding: 10px;
      transition: all 0.2s;
    }

    .radio-item:has(input:checked) {
      background: #eaf2ff;
      border-color: var(--navy);
    }

    .radio-item input { accent-color: var(--navy); }
    .radio-item span { font-size: 13px; font-weight: 600; }

    /* Camera section */
    .photo-area {
      border: 2px dashed var(--gray-200);
      border-radius: var(--radius);
      cursor: pointer;
      min-height: 160px;
      overflow: hidden;
      position: relative;
      transition: border-color 0.2s;
    }

    .photo-area:hover { border-color: var(--navy); }

    .photo-placeholder {
      align-items: center;
      display: flex;
      flex-direction: column;
      gap: 10px;
      justify-content: center;
      min-height: 160px;
      padding: 20px;
      text-align: center;
    }

    .photo-placeholder .camera-icon { font-size: 40px; opacity: 0.35; }

    .photo-placeholder p {
      color: var(--gray-400);
      font-size: 13px;
      line-height: 1.4;
    }

    .photo-preview {
      display: none;
      position: relative;
    }

    .photo-preview img {
      border-radius: calc(var(--radius) - 2px);
      display: block;
      max-height: 300px;
      object-fit: cover;
      width: 100%;
    }

    .photo-remove {
      background: var(--danger);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      font-size: 14px;
      height: 30px;
      line-height: 30px;
      position: absolute;
      right: 8px;
      text-align: center;
      top: 8px;
      width: 30px;
    }

    #photo-input { display: none; }

    /* Submit button */
    .btn-submit {
      width: 100%;
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      border: none;
      border-radius: var(--radius);
      color: var(--white);
      cursor: pointer;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.5px;
      padding: 16px;
      transition: opacity 0.2s, transform 0.1s;
    }

    .btn-submit:active { transform: scale(0.98); opacity: 0.9; }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary {
      width: 100%;
      background: none;
      border: 2px solid var(--navy);
      border-radius: var(--radius);
      color: var(--navy);
      cursor: pointer;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 14px;
      font-weight: 700;
      padding: 13px;
      margin-top: 10px;
      transition: all 0.2s;
    }

    .btn-secondary:active { background: var(--gray-100); }

    /* Loading spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      display: inline-block;
      height: 18px;
      width: 18px;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast */
    .toast {
      background: var(--navy);
      border-radius: var(--radius);
      bottom: 20px;
      box-shadow: var(--shadow);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      left: 50%;
      opacity: 0;
      padding: 14px 20px;
      position: fixed;
      transform: translate(-50%, 20px);
      transition: all 0.3s ease;
      z-index: 9999;
      max-width: 85vw;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* List tab */
    .search-bar {
      background: var(--white);
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }

    .search-bar input {
      background: none;
      border: none;
      color: var(--gray-800);
      flex: 1;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 14px;
      outline: none;
    }

    .search-bar .search-icon { color: var(--gray-400); font-size: 18px; }

    .ficha-list { display: flex; flex-direction: column; gap: 10px; }

    .ficha-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      overflow: hidden;
      transition: box-shadow 0.2s;
    }

    .ficha-card:active { box-shadow: var(--shadow); }

    .ficha-card-inner {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
    }

    .ficha-avatar {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      border-radius: 50%;
      color: var(--white);
      flex-shrink: 0;
      font-family: 'Merriweather', serif;
      font-size: 18px;
      height: 46px;
      line-height: 46px;
      text-align: center;
      width: 46px;
    }

    .ficha-info { flex: 1; min-width: 0; }

    .ficha-info h3 {
      color: var(--navy);
      font-family: 'Merriweather', serif;
      font-size: 14px;
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ficha-info p {
      color: var(--gray-400);
      font-size: 12px;
      margin-top: 2px;
    }

    .ficha-badge {
      background: var(--gray-100);
      border-radius: 6px;
      color: var(--gray-600);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      text-transform: uppercase;
    }

    .ficha-badge.inclusao { background: #e8f5e9; color: #27ae60; }
    .ficha-badge.exclusao { background: #ffebee; color: #c0392b; }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--gray-400);
    }

    .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state p { font-size: 14px; line-height: 1.5; }

    /* Modal */
    .modal-overlay {
      background: rgba(0,0,0,0.55);
      bottom: 0;
      display: none;
      left: 0;
      position: fixed;
      right: 0;
      top: 0;
      z-index: 500;
      align-items: flex-end;
    }

    .modal-overlay.show { display: flex; }

    .modal-sheet {
      background: var(--white);
      border-radius: 20px 20px 0 0;
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-handle {
      background: var(--gray-200);
      border-radius: 2px;
      height: 4px;
      margin: 12px auto 0;
      width: 40px;
    }

    .modal-header {
      align-items: center;
      display: flex;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h2 {
      font-family: 'Merriweather', serif;
      font-size: 16px;
      color: var(--navy);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
      padding: 4px;
    }

    .modal-body { padding: 20px; }

    .detail-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--gray-100);
    }

    .detail-row:last-child { border-bottom: none; }

    .detail-label {
      color: var(--gray-400);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    .detail-value {
      color: var(--gray-800);
      font-size: 14px;
    }

    .detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .detail-tag {
      background: #eaf2ff;
      border-radius: 6px;
      color: var(--navy);
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
    }

    .modal-photo {
      border-radius: var(--radius);
      display: block;
      margin-top: 8px;
      max-width: 100%;
    }

    .btn-danger {
      width: 100%;
      background: none;
      border: 2px solid var(--danger);
      border-radius: var(--radius);
      color: var(--danger);
      cursor: pointer;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 14px;
      font-weight: 700;
      padding: 13px;
      margin-top: 10px;
    }

    /* Config tab */
    .config-section { margin-bottom: 24px; }
    .config-section h3 {
      color: var(--navy);
      font-family: 'Merriweather', serif;
      font-size: 13px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--gold);
      display: inline-block;
    }

    .config-info {
      background: var(--white);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }

    .config-info p {
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.6;
    }

    .config-info strong { color: var(--navy); }

    .firebase-fields { display: flex; flex-direction: column; gap: 10px; }
    .firebase-fields input {
      width: 100%;
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius-sm);
      color: var(--gray-800);
      font-family: 'Source Sans 3', sans-serif;
      font-size: 12px;
      padding: 10px 12px;
      outline: none;
    }

    .firebase-fields input:focus { border-color: var(--navy); }
    .firebase-fields input::placeholder { color: var(--gray-400); }

    .user-info {
      background: var(--white);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 12px;
    }

    .user-avatar {
      background: var(--navy);
      border-radius: 50%;
      color: var(--white);
      font-size: 20px;
      height: 46px;
      line-height: 46px;
      text-align: center;
      width: 46px;
      flex-shrink: 0;
    }

    .user-details h3 { font-size: 15px; font-weight: 700; color: var(--navy); }
    .user-details p { font-size: 12px; color: var(--gray-400); }


    /* ‚îÄ‚îÄ CROP EDITOR ‚îÄ‚îÄ */
    .crop-overlay {
      display: none; position: fixed; inset: 0;
      background: #000; z-index: 9997;
      flex-direction: column; align-items: center;
    }
    .crop-overlay.show { display: flex; }
    .crop-topbar {
      width: 100%; background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; flex-shrink: 0;
    }
    .crop-topbar span { color: white; font-size: 15px; font-weight: 700; font-family: 'Merriweather', serif; }
    .crop-topbar button { background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 22px; }
    .crop-viewport {
      flex: 1; width: 100%; overflow: hidden; position: relative;
      display: flex; align-items: center; justify-content: center;
    }
    #crop-canvas { display: block; max-width: 100vw; max-height: calc(100vh - 170px); }
    .crop-box {
      position: absolute; border: 2px solid #fff;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
      cursor: move; touch-action: none; box-sizing: border-box;
    }
    .crop-box::before {
      content: ''; position: absolute;
      left: 33.33%; right: 33.33%; top: 0; bottom: 0;
      border-left: 1px solid rgba(255,255,255,0.35);
      border-right: 1px solid rgba(255,255,255,0.35);
    }
    .crop-box::after {
      content: ''; position: absolute;
      top: 33.33%; bottom: 33.33%; left: 0; right: 0;
      border-top: 1px solid rgba(255,255,255,0.35);
      border-bottom: 1px solid rgba(255,255,255,0.35);
    }
    .crop-handle {
      position: absolute; width: 22px; height: 22px;
      border-color: #fff; border-style: solid; touch-action: none;
    }
    .crop-handle.tl { top:-2px; left:-2px; border-width:3px 0 0 3px; cursor:nw-resize; }
    .crop-handle.tr { top:-2px; right:-2px; border-width:3px 3px 0 0; cursor:ne-resize; }
    .crop-handle.bl { bottom:-2px; left:-2px; border-width:0 0 3px 3px; cursor:sw-resize; }
    .crop-handle.br { bottom:-2px; right:-2px; border-width:0 3px 3px 0; cursor:se-resize; }
    .crop-bottombar {
      width: 100%; background: rgba(0,0,0,0.85);
      padding: 12px 16px; display: flex; gap: 10px; flex-shrink: 0;
    }
    .crop-btn {
      flex: 1; border: none; border-radius: 10px; cursor: pointer;
      font-family: 'Source Sans 3', sans-serif; font-size: 14px;
      font-weight: 700; padding: 13px 8px;
    }
    .crop-btn.rotate-l, .crop-btn.rotate-r {
      background: rgba(255,255,255,0.12); color: white;
      font-size: 20px; flex: 0 0 52px;
    }
    .crop-btn.cancel { background: rgba(255,255,255,0.12); color: white; }
    .crop-btn.confirm { background: var(--gold); color: var(--navy); }

    .lightbox {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      z-index: 9998;
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
    }
    .lightbox.show { display: flex; }
    .lightbox img {
      max-width: 95vw;
      max-height: 95vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    }
    .lightbox-close {
      position: absolute;
      top: 16px;
      right: 20px;
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
      opacity: 0.8;
    }
    .lightbox-close:hover { opacity: 1; }
    .modal-photo {
      cursor: zoom-in;
      transition: opacity 0.2s;
    }
    .modal-photo:hover { opacity: 0.85; }
      position: fixed;
      inset: 0;
      background: linear-gradient(160deg, var(--navy) 0%, #0d2340 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s;
    }

    #loader .cross { font-size: 52px; color: var(--gold); margin-bottom: 16px; }
    #loader p { color: rgba(255,255,255,0.6); font-size: 13px; }
    .loader-bar {
      width: 120px;
      height: 3px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin-top: 16px;
      overflow: hidden;
    }
    .loader-bar-fill {
      height: 100%;
      width: 40%;
      background: var(--gold);
      border-radius: 2px;
      animation: loading 1.2s ease-in-out infinite;
    }

    @keyframes loading {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }

    /* ‚îÄ‚îÄ RESUMO TAB ‚îÄ‚îÄ */
    .resumo-header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      color: var(--white);
      text-align: center;
    }
    .resumo-header .resumo-total {
      font-size: 48px;
      font-family: 'Merriweather', serif;
      font-weight: 700;
      color: var(--gold-light);
      line-height: 1;
    }
    .resumo-header .resumo-label {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-top: 4px;
      letter-spacing: 0.5px;
    }
    .resumo-mini-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .resumo-mini-card {
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      padding: 12px 10px;
      text-align: center;
    }
    .resumo-mini-card .mini-val {
      font-family: 'Merriweather', serif;
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
    }
    .resumo-mini-card .mini-val.inclusao { color: var(--success); }
    .resumo-mini-card .mini-val.exclusao { color: var(--danger); }
    .resumo-mini-card .mini-val.pendente { color: #e67e22; }
    .resumo-mini-card .mini-lbl {
      font-size: 10px;
      font-weight: 600;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 3px;
    }
    .resumo-section-title {
      font-family: 'Merriweather', serif;
      font-size: 13px;
      color: var(--navy);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--gold);
      display: inline-block;
    }
    .cargo-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .cargo-item {
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
    }
    .cargo-icon {
      font-size: 22px;
      flex-shrink: 0;
      width: 36px;
      text-align: center;
    }
    .cargo-name { flex: 1; font-size: 13px; font-weight: 600; color: var(--gray-800); }
    .cargo-bar-wrap { flex: 2; }
    .cargo-bar-bg {
      background: var(--gray-100);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
    }
    .cargo-bar-fill {
      background: linear-gradient(90deg, var(--navy), var(--navy-light));
      border-radius: 4px;
      height: 8px;
      transition: width 0.6s ease;
    }
    .cargo-count {
      font-family: 'Merriweather', serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--navy);
      min-width: 24px;
      text-align: right;
    }
    .aprovacao-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .aprovacao-item {
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
    }
    .localidade-list { display: flex; flex-direction: column; gap: 8px; }
    .localidade-item {
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
    }
    .localidade-item .loc-name { font-size: 13px; font-weight: 600; color: var(--gray-800); }
    .localidade-badge {
      background: #eaf2ff;
      color: var(--navy);
      font-size: 12px;
      font-weight: 700;
      border-radius: 20px;
      padding: 3px 10px;
    }
    .resumo-empty { text-align: center; padding: 32px 20px; color: var(--gray-400); font-size: 14px; }

    /* Utility */
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .text-center { text-align: center; }
    .text-xs { font-size: 12px; color: var(--gray-400); }
  </style>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <p>Congrega√ß√£o Crist√£ no Brasil</p>
  <div class="loader-bar"><div class="loader-bar-fill"></div></div>
</div>

<!-- Main App -->
<div id="app">
  <header class="app-header">
    <div class="brand">
      <div>
        <h1>CCB Caieiras</h1>
        <p>Fichas de Apresenta√ß√£o</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openNewFicha()" title="Nova ficha">Ôºã</button>
    </div>
  </header>

  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="tab-list">
      <span>üìã</span>Fichas
    </button>
    <button class="tab-btn" data-tab="tab-resumo">
      <span>üìä</span>Resumo
    </button>
    <button class="tab-btn" data-tab="tab-form">
      <span>‚ûï</span>Nova
    </button>
    <button class="tab-btn" data-tab="tab-config">
      <span>‚öôÔ∏è</span>Config
    </button>
  </nav>

  <!-- TAB: LIST -->
  <div class="tab-content active" id="tab-list">
    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input type="text" id="search-input" placeholder="Buscar por nome, localidade..." oninput="filterFichas()" />
    </div>
    <div class="ficha-list" id="ficha-list">
      <div class="empty-state">
        <div class="empty-icon">üìÇ</div>
        <p>Nenhuma ficha cadastrada ainda.<br>Toque em <strong>Nova</strong> para come√ßar.</p>
      </div>
    </div>
  </div>

  <!-- TAB: FORM -->
  <div class="tab-content" id="tab-form">

    <!-- Cabe√ßalho Ministerial -->
    <div class="form-card">
      <div class="form-card-header">üìÖ Reuni√£o Ministerial</div>
      <div class="form-card-body">
        <div class="field">
          <label>Considerado na Reuni√£o de</label>
          <input type="date" id="f-data-reuniao" />
        </div>
        <div class="field">
          <label>Aprovado</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="aprovado" value="SIM" id="r-sim" />
              <span>‚úÖ SIM</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="aprovado" value="N√ÉO" id="r-nao" />
              <span>‚ùå N√ÉO</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="aprovado" value="PENDENTE" id="r-pend" checked />
              <span>‚è≥ Pendente</span>
            </label>
          </div>
        </div>
        <div class="field">
          <label>Tipo</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="tipo" value="INCLUS√ÉO" id="t-inc" checked />
              <span>Inclus√£o</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="tipo" value="EXCLUS√ÉO" id="t-exc" />
              <span>Exclus√£o</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Cargos e Reuni√µes -->
    <div class="form-card">
      <div class="form-card-header">üèõ Cargos e Reuni√µes Familiares</div>
      <div class="form-card-body">
        <div class="field">
          <label>Localidade</label>
          <input type="text" id="f-localidade" list="lista-igrejas" placeholder="Selecione ou digite a localidade" autocomplete="off" />
          <datalist id="lista-igrejas"></datalist>
        </div>
        <div class="field mt-8">
          <label>Cargos / Fun√ß√µes</label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" id="cb-portaria" />
              <span>Portaria</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-parte-externa" />
              <span>Parte Externa</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-auxiliar-rjm" />
              <span>Auxiliar de R.J.M</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-controle-som" />
              <span>Controle do Som</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-reuniao-evang" />
              <span>Reuni√£o de Evangeliza√ß√£o</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-reuniao-enfermo" />
              <span>Reuni√£o para Enfermo</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-fundo-biblico" />
              <span>Fundo B√≠blico / Distribui√ß√£o</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-colaborador-admin" />
              <span>Colaborador(a) Administra√ß√£o</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-colaborador-piedade" />
              <span>Colaborador(a) da Piedade</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="cb-outros" />
              <span>Outros</span>
            </label>
          </div>
        </div>
        <div class="field" id="field-outros-desc" style="display:none">
          <label>Especificar "Outros"</label>
          <input type="text" id="f-outros-desc" placeholder="Descreva o cargo/fun√ß√£o" />
        </div>
      </div>
    </div>

    <!-- Dados Pessoais -->
    <div class="form-card">
      <div class="form-card-header">üë§ Dados Pessoais</div>
      <div class="form-card-body">
        <div class="field">
          <label>Nome Completo *</label>
          <input type="text" id="f-nome" placeholder="Nome completo do irm√£o/irm√£" />
        </div>
        <div class="field-row">
          <div class="field">
            <label>Idade</label>
            <input type="number" id="f-idade" placeholder="00" min="0" max="120" />
          </div>
          <div class="field">
            <label>Tempo de Batismo</label>
            <input type="text" id="f-tempo-batismo" placeholder="Ex: 5 anos" />
          </div>
        </div>
        <div class="field">
          <label>Endere√ßo</label>
          <input type="text" id="f-endereco" placeholder="Rua, n√∫mero, bairro..." />
        </div>
        <div class="field">
          <label>Telefone</label>
          <input type="tel" id="f-telefone" placeholder="(11) 99999-9999" />
        </div>
        <div class="field">
          <label>Refer√™ncias</label>
          <input type="text" id="f-referencias" placeholder="Refer√™ncias da pessoa" />
        </div>
        <div class="field">
          <label>Observa√ß√µes</label>
          <textarea id="f-obs" placeholder="Observa√ß√µes gerais..."></textarea>
        </div>
      </div>
    </div>

    <!-- Foto da Ficha -->
    <div class="form-card">
      <div class="form-card-header">üì∑ Foto da Ficha Original</div>
      <div class="form-card-body">
        <div class="photo-area" onclick="document.getElementById('photo-input').click()">
          <div class="photo-placeholder" id="photo-placeholder">
            <span class="camera-icon">üì∑</span>
            <p>Toque aqui para <strong>tirar foto</strong> ou <strong>selecionar</strong> a ficha original</p>
          </div>
          <div class="photo-preview" id="photo-preview">
            <img id="photo-img" src="" alt="Foto da ficha" />
            <button class="photo-remove" onclick="removePhoto(event)">‚úï</button>
          </div>
        </div>
        <input type="file" id="photo-input" accept="image/*" capture="environment" onchange="handlePhoto(event)" />
        <p class="text-xs mt-8">A foto ser√° armazenada no seu OneDrive</p>
      </div>
    </div>

    <!-- Actions -->
    <button class="btn-submit" id="btn-salvar" onclick="salvarFicha()">
      üíæ Salvar Ficha
    </button>
    <button class="btn-secondary" id="btn-cancelar" onclick="cancelarFicha()">
      Cancelar
    </button>
    <div style="height: 32px"></div>

  </div>

  <!-- TAB: RESUMO -->
  <div class="tab-content" id="tab-resumo">
    <div class="resumo-header">
      <div class="resumo-total" id="r-total">0</div>
      <div class="resumo-label">fichas cadastradas</div>
    </div>

    <div class="resumo-mini-stats">
      <div class="resumo-mini-card">
        <div class="mini-val inclusao" id="r-inclusao">0</div>
        <div class="mini-lbl">‚úÖ Inclus√£o</div>
      </div>
      <div class="resumo-mini-card">
        <div class="mini-val exclusao" id="r-exclusao">0</div>
        <div class="mini-lbl">‚ùå Exclus√£o</div>
      </div>
      <div class="resumo-mini-card">
        <div class="mini-val pendente" id="r-pendente">0</div>
        <div class="mini-lbl">‚è≥ Pendente</div>
      </div>
    </div>

    <div id="resumo-corpo">
      <div class="resumo-empty">Nenhuma ficha cadastrada ainda.</div>
    </div>
  </div>

  <!-- TAB: CONFIG -->
  <div class="tab-content" id="tab-config">

    <!-- OneDrive Status -->
    <div class="config-section">
      <h3>‚òÅÔ∏è OneDrive</h3>
      <div id="od-status" class="config-info" style="display:block">
        <p id="od-status-text">‚ö†Ô∏è OneDrive n√£o conectado.</p>
      </div>
      <div class="firebase-fields mt-12" id="od-fields">
        <input type="text" id="od-clientId" placeholder="Client ID do Azure" />
        <input type="text" id="od-redirectUri" placeholder="Redirect URI (URL do app)" />
      </div>
      <button class="btn-submit mt-12" onclick="saveOneDriveConfig()">Salvar OneDrive</button>
      <button class="btn-secondary" id="btn-od-login" onclick="loginOneDrive()" style="display:none">
        üîë Conectar ao OneDrive
      </button>
    </div>

    <!-- Cadastro de Igrejas / Localidades -->
    <div class="config-section">
      <h3>üèõ Localidades / Igrejas</h3>
      <div class="config-info" style="margin-bottom:12px">
        <p style="font-size:13px;color:var(--gray-600)">As localidades cadastradas aqui aparecem como lista no campo <strong>Localidade</strong> ao preencher uma ficha.</p>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input type="text" id="nova-igreja" placeholder="Nome da localidade/igreja"
          style="flex:1;background:var(--gray-100);border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);color:var(--gray-800);font-family:'Source Sans 3',sans-serif;font-size:14px;padding:10px 12px;outline:none;"
          onkeydown="if(event.key==='Enter') adicionarIgreja()"
          onfocus="this.style.borderColor='var(--navy)'" onblur="this.style.borderColor='var(--gray-200)'" />
        <button onclick="adicionarIgreja()" style="background:var(--navy);border:none;border-radius:var(--radius-sm);color:white;cursor:pointer;font-size:20px;padding:10px 16px;flex-shrink:0">Ôºã</button>
      </div>
      <div id="lista-igrejas-config"></div>
    </div>

    <!-- Stats -->
    <div class="config-section">
      <h3>üìä Dados</h3>
      <div class="config-info">
        <p>Total de fichas: <strong id="total-fichas">0</strong></p>
        <p>Armazenamento: <strong id="storage-info">Local</strong></p>
      </div>
    </div>

    <!-- Firebase oculto (campos mantidos para compatibilidade) -->
    <div style="display:none">
      <input type="text" id="fb-apiKey" /><input type="text" id="fb-authDomain" />
      <input type="text" id="fb-projectId" /><input type="text" id="fb-storageBucket" />
      <input type="text" id="fb-messagingSenderId" /><input type="text" id="fb-appId" />
    </div>

  </div>

</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2 id="modal-title">Detalhes da Ficha</h2>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body">
    </div>
  </div>
</div>

<!-- Crop Editor -->
<div class="crop-overlay" id="crop-overlay">
  <div class="crop-topbar">
    <span>‚úÇÔ∏è Enquadrar foto</span>
    <button onclick="cancelCrop()">‚úï</button>
  </div>
  <div class="crop-viewport" id="crop-viewport">
    <canvas id="crop-canvas"></canvas>
    <div class="crop-box" id="crop-box">
      <div class="crop-handle tl" data-handle="tl"></div>
      <div class="crop-handle tr" data-handle="tr"></div>
      <div class="crop-handle bl" data-handle="bl"></div>
      <div class="crop-handle br" data-handle="br"></div>
    </div>
  </div>
  <div class="crop-bottombar">
    <button class="crop-btn rotate-l" onclick="rotateCrop(-90)" title="Girar esquerda">‚Ü∫</button>
    <button class="crop-btn rotate-r" onclick="rotateCrop(90)" title="Girar direita">‚Üª</button>
    <button class="crop-btn cancel" onclick="cancelCrop()">Cancelar</button>
    <button class="crop-btn confirm" onclick="confirmCrop()">‚úÖ Usar foto</button>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
  <img id="lightbox-img" src="" alt="Foto da ficha" onclick="event.stopPropagation()" />
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fichas = [];
let currentEditId = null;
let currentPhotoFile = null;
let currentPhotoBase64 = null;
let isAuthMode = 'login';
let db = null;
let auth = null;
let currentUser = null;
let fbApp = null;

// OneDrive / MSAL
let msalInstance = null;
let oneDriveAccount = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONEDRIVE COMO ARMAZENAMENTO PRINCIPAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveFichasOneDrive() {
  const token = await getOneDriveToken();
  if (!token) return;
  try {
    const json = JSON.stringify(fichas);
    await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/CCB-Fichas/fichas.json:/content', {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: json
    });
  } catch(e) { console.error('Erro ao salvar fichas no OneDrive:', e); }
}

async function loadFichasOneDrive() {
  const token = await getOneDriveToken();
  if (!token) return false;
  try {
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/CCB-Fichas/fichas.json:/content', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (resp.status === 404) { fichas = []; return true; }
    if (!resp.ok) return false;
    fichas = await resp.json();
    return true;
  } catch(e) { console.error('Erro ao carregar fichas:', e); return false; }
}

function saveLocal() {
  try { localStorage.setItem('ccb_fichas_backup', JSON.stringify(fichas)); } catch(e) {}
}

function loadLocal() {
  try {
    const saved = localStorage.getItem('ccb_fichas_backup');
    fichas = saved ? JSON.parse(saved) : [];
  } catch(e) { fichas = []; }
}

// ‚îÄ‚îÄ IGREJAS / LOCALIDADES ‚îÄ‚îÄ
let igrejas = [];

function loadIgrejas() {
  try {
    const saved = localStorage.getItem('ccb_igrejas');
    igrejas = saved ? JSON.parse(saved) : [];
  } catch(e) { igrejas = []; }
}

function saveIgrejas() {
  try { localStorage.setItem('ccb_igrejas', JSON.stringify(igrejas)); } catch(e) {}
}

function adicionarIgreja() {
  const input = document.getElementById('nova-igreja');
  const nome = input.value.trim();
  if (!nome) { showToast('Digite o nome da localidade', 'error'); return; }
  if (igrejas.includes(nome)) { showToast('Localidade j√° cadastrada', 'error'); return; }
  igrejas.push(nome);
  igrejas.sort((a, b) => a.localeCompare(b, 'pt-BR'));
  saveIgrejas();
  input.value = '';
  renderIgrejas();
  atualizarDatalistIgrejas();
  showToast('‚úÖ Localidade adicionada!', 'success');
}

function removerIgreja(nome) {
  igrejas = igrejas.filter(i => i !== nome);
  saveIgrejas();
  renderIgrejas();
  atualizarDatalistIgrejas();
  showToast('üóë Localidade removida', 'error');
}

function renderIgrejas() {
  const container = document.getElementById('lista-igrejas-config');
  if (!container) return;
  if (igrejas.length === 0) {
    container.innerHTML = '<p style="font-size:13px;color:var(--gray-400);text-align:center;padding:12px">Nenhuma localidade cadastrada ainda.</p>';
    return;
  }
  container.innerHTML = igrejas.map(nome => `
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--white);border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:8px">
      <span style="font-size:14px;font-weight:600;color:var(--navy)">üè† ${nome}</span>
      <button onclick="removerIgreja(decodeURIComponent('${encodeURIComponent(nome)}'))" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:18px;line-height:1;padding:2px 6px">‚úï</button>
    </div>
  `).join('');
}

function atualizarDatalistIgrejas() {
  const dl = document.getElementById('lista-igrejas');
  if (!dl) return;
  dl.innerHTML = igrejas.map(nome => `<option value="${nome}"></option>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadFirebaseConfig() {
  try {
    return JSON.parse(localStorage.getItem('ccb_fb_config') || 'null');
  } catch(e) { return null; }
}

function initFirebase(config) {
  try {
    if (fbApp) { try { firebase.app().delete(); } catch(e) {} }
    fbApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(config);
    auth = firebase.auth();
    db = firebase.firestore();
    return true;
  } catch(e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

function saveFirebaseConfig() {
  const config = {
    apiKey: document.getElementById('fb-apiKey').value.trim(),
    authDomain: document.getElementById('fb-authDomain').value.trim(),
    projectId: document.getElementById('fb-projectId').value.trim(),
    storageBucket: document.getElementById('fb-storageBucket').value.trim(),
    messagingSenderId: document.getElementById('fb-messagingSenderId').value.trim(),
    appId: document.getElementById('fb-appId').value.trim(),
  };
  if (!config.apiKey || !config.projectId) {
    showToast('Preencha pelo menos apiKey e projectId', 'error');
    return;
  }
  localStorage.setItem('ccb_fb_config', JSON.stringify(config));
  const ok = initFirebase(config);
  showToast(ok ? 'üî• Firebase conectado!' : 'Erro ao conectar Firebase', ok ? 'success' : 'error');
}

function setupAuthListener() {
  // Sem autentica√ß√£o ‚Äî app sempre dispon√≠vel
  if (auth) {
    auth.onAuthStateChanged(user => {
      currentUser = user || { uid: 'local', displayName: 'Admin' };
      if (oneDriveAccount) syncFromCloud();
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH (desativado ‚Äî acesso direto)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Sem autentica√ß√£o ‚Äî fun√ß√µes mantidas para compatibilidade
async function signInWithGoogle() {}
async function signOutUser() {}
function setAuthError(msg) {}
function showApp(user) {}
function showAuthScreen() {}
function setupAuthListener() {}

let authMode = 'login';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOUD SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function syncFromCloud() {
  if (!oneDriveAccount) return;
  showToast('üîÑ Carregando fichas...', '');
  const ok = await loadFichasOneDrive();
  if (ok) {
    saveLocal(); // atualiza backup local com dados da nuvem
    renderFichas();
    updateStats();
    document.getElementById('storage-info').textContent = '‚òÅÔ∏è OneDrive';
  }
}

async function saveToCloud(ficha) {
  try {
    await saveFichasOneDrive();
    saveLocal(); // sempre salva backup local tamb√©m
  } catch(e) {
    saveLocal();
    showToast('‚ö†Ô∏è Salvo localmente. OneDrive indispon√≠vel.', '');
  }
}

async function deleteFromCloud(id) {
  try {
    await saveFichasOneDrive();
    saveLocal();
  } catch(e) { saveLocal(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONEDRIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadOneDriveConfig() {
  try { return JSON.parse(localStorage.getItem('ccb_od_config') || 'null'); } catch(e) { return null; }
}

function saveOneDriveConfig() {
  const clientId = document.getElementById('od-clientId').value.trim();
  const redirectUri = document.getElementById('od-redirectUri').value.trim() || window.location.href.split('?')[0];
  if (!clientId) { showToast('Informe o Client ID do Azure', 'error'); return; }
  const cfg = { clientId, redirectUri };
  localStorage.setItem('ccb_od_config', JSON.stringify(cfg));
  // Mostra o bot√£o conectar imediatamente
  document.getElementById('btn-od-login').style.display = 'block';
  document.getElementById('btn-od-login').textContent = 'üîë Conectar ao OneDrive';
  showToast('‚úÖ Configura√ß√£o salva! Agora clique em Conectar.', 'success');
  initMSAL(cfg);
}

async function initMSAL(cfg) {
  try {
    if (typeof msal === 'undefined') {
      showToast('Biblioteca MSAL n√£o carregou. Verifique sua conex√£o.', 'error');
      return;
    }
    msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: cfg.clientId,
        authority: 'https://login.microsoftonline.com/common',
        redirectUri: cfg.redirectUri || window.location.href.split('?')[0],
      },
      cache: { cacheLocation: 'localStorage' }
    });
    if (msalInstance.initialize) {
      await msalInstance.initialize();
    }

    const CONTA_CORRETA = 'secretaria_ccb_caieiras@hotmail.com';

    // Remove qualquer conta que N√ÉO seja a conta correta
    const accounts = msalInstance.getAllAccounts();
    for (const acc of accounts) {
      if (acc.username.toLowerCase() !== CONTA_CORRETA.toLowerCase()) {
        try { await msalInstance.logoutPopup({ account: acc, mainWindowRedirectUri: window.location.href }); } catch(e) {}
        msalInstance.getTokenCache && msalInstance.getTokenCache().removeAccount && msalInstance.getTokenCache().removeAccount(acc);
      }
    }

    // Verifica se a conta correta est√° logada
    const accountsApos = msalInstance.getAllAccounts();
    const contaCorreta = accountsApos.find(a => a.username.toLowerCase() === CONTA_CORRETA.toLowerCase());
    if (contaCorreta) {
      oneDriveAccount = contaCorreta;
      updateOneDriveStatus(true);
    } else {
      oneDriveAccount = null;
      updateOneDriveStatus(false);
    }
    document.getElementById('btn-od-login').style.display = 'block';
  } catch(e) {
    console.error('MSAL init error:', e);
    showToast('Erro ao inicializar: ' + e.message, 'error');
  }
}

async function loginOneDrive() {
  const cfg = loadOneDriveConfig();
  if (!cfg || !cfg.clientId) {
    showToast('Configure e salve o Client ID primeiro', 'error');
    return;
  }
  // Se msalInstance n√£o est√° pronto, inicializa agora
  if (!msalInstance) {
    await initMSAL(cfg);
  }
  if (!msalInstance) {
    showToast('Falha ao carregar biblioteca Microsoft. Recarregue a p√°gina.', 'error');
    return;
  }
  try {
    const resp = await msalInstance.loginPopup({
      scopes: ['Files.ReadWrite', 'User.Read'],
      loginHint: 'secretaria_ccb_caieiras@hotmail.com',
      prompt: 'login'
    });
    oneDriveAccount = resp.account;
    updateOneDriveStatus(true);
    showToast('‚úÖ OneDrive conectado!', 'success');
    await syncFromCloud();
  } catch(e) {
    console.error('Login OneDrive error:', e);
    if (e.errorCode === 'popup_window_error') {
      showToast('Popup bloqueado! Permita popups para este site.', 'error');
    } else if (e.errorCode === 'user_cancelled') {
      showToast('Login cancelado.', '');
    } else {
      showToast('Erro: ' + (e.errorMessage || e.message), 'error');
    }
  }
}

function updateOneDriveStatus(connected) {
  const el = document.getElementById('od-status');
  const txt = document.getElementById('od-status-text');
  el.style.display = 'block';
  if (connected && oneDriveAccount) {
    txt.innerHTML = `‚úÖ Conectado como <strong>${oneDriveAccount.username}</strong>`;
    document.getElementById('storage-info').textContent = '‚òÅÔ∏è OneDrive';
    document.getElementById('btn-od-login').textContent = 'üîÑ Reconectar OneDrive';
  } else {
    txt.innerHTML = '‚ö†Ô∏è OneDrive n√£o conectado. Clique em <strong>Conectar ao OneDrive</strong>.';
  }
}

async function getOneDriveToken() {
  if (!msalInstance || !oneDriveAccount) return null;
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: ['Files.ReadWrite'],
      account: oneDriveAccount
    });
    return resp.accessToken;
  } catch(e) {
    try {
      const resp = await msalInstance.acquireTokenPopup({
        scopes: ['Files.ReadWrite'],
        loginHint: 'secretaria_ccb_caieiras@hotmail.com',
        prompt: 'login'
      });
      return resp.accessToken;
    } catch(e2) { return null; }
  }
}

async function uploadPhoto(file, fichaId) {
  const token = await getOneDriveToken();
  if (!token) return null;
  try {
    // Compress image before upload
    const compressed = await compressImage(file, 800, 0.7);
    const ext = file.type === 'image/png' ? 'png' : 'jpg';
    const filename = `${fichaId}.${ext}`;
    // Upload to OneDrive folder CCB-Fichas
    const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/CCB-Fichas/${filename}:/content`;
    const resp = await fetch(uploadUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': file.type
      },
      body: compressed
    });
    if (!resp.ok) throw new Error('Upload failed: ' + resp.status);
    const data = await resp.json();
    // Create share link
    const shareResp = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${data.id}/createLink`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ type: 'view', scope: 'anonymous' })
    });
    if (shareResp.ok) {
      const shareData = await shareResp.json();
      // Convert to direct image URL
      const shareUrl = shareData.link.webUrl;
      const directUrl = shareUrl.replace('1drv.ms', 'api.onedrive.com').replace('/s!', '/shares/s!') ;
      return shareUrl; // return share URL, will display via proxy or direct
    }
    return data.webUrl || null;
  } catch(e) {
    console.error('OneDrive upload error:', e);
    return null;
  }
}

function compressImage(file, maxWidth, quality) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(resolve, 'image/jpeg', quality);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('cb-outros').addEventListener('change', e => {
  document.getElementById('field-outros-desc').style.display = e.target.checked ? 'block' : 'none';
});

function openNewFicha() {
  currentEditId = null;
  resetForm();
  switchTab('tab-form');
}

function cancelarFicha() {
  resetForm();
  switchTab('tab-list');
}

function resetForm() {
  document.getElementById('f-data-reuniao').value = '';
  document.getElementById('r-pend').checked = true;
  document.getElementById('t-inc').checked = true;
  document.getElementById('f-localidade').value = '';
  document.getElementById('f-nome').value = '';
  document.getElementById('f-idade').value = '';
  document.getElementById('f-tempo-batismo').value = '';
  document.getElementById('f-endereco').value = '';
  document.getElementById('f-telefone').value = '';
  document.getElementById('f-referencias').value = '';
  document.getElementById('f-obs').value = '';
  document.getElementById('f-outros-desc').value = '';
  document.getElementById('field-outros-desc').style.display = 'none';
  const cbs = ['portaria','parte-externa','auxiliar-rjm','controle-som','reuniao-evang',
    'reuniao-enfermo','fundo-biblico','colaborador-admin','colaborador-piedade','outros'];
  cbs.forEach(id => { const el = document.getElementById('cb-'+id); if(el) el.checked = false; });
  removePhoto(null);
  currentEditId = null;
}

function getFormData() {
  const cbs = ['portaria','parte-externa','auxiliar-rjm','controle-som','reuniao-evang',
    'reuniao-enfermo','fundo-biblico','colaborador-admin','colaborador-piedade','outros'];
  const cargos = cbs.filter(id => {
    const el = document.getElementById('cb-'+id);
    return el && el.checked;
  }).map(id => id.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase()));

  return {
    dataReuniao: document.getElementById('f-data-reuniao').value,
    aprovado: document.querySelector('input[name="aprovado"]:checked')?.value || 'PENDENTE',
    tipo: document.querySelector('input[name="tipo"]:checked')?.value || 'INCLUS√ÉO',
    localidade: document.getElementById('f-localidade').value.trim(),
    nome: document.getElementById('f-nome').value.trim(),
    idade: document.getElementById('f-idade').value,
    tempoBatismo: document.getElementById('f-tempo-batismo').value.trim(),
    endereco: document.getElementById('f-endereco').value.trim(),
    telefone: document.getElementById('f-telefone').value.trim(),
    referencias: document.getElementById('f-referencias').value.trim(),
    obs: document.getElementById('f-obs').value.trim(),
    outrosDesc: document.getElementById('f-outros-desc').value.trim(),
    cargos,
    photoBase64: currentPhotoBase64 || null,
    photoURL: null,
    criadoEm: new Date().toISOString(),
  };
}

async function salvarFicha() {
  const data = getFormData();
  if (!data.nome) { showToast('Informe o nome da pessoa', 'error'); return; }

  const btn = document.getElementById('btn-salvar');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Salvando...';

  try {
    const id = currentEditId || 'ficha_' + Date.now() + '_' + Math.random().toString(36).substr(2,6);
    data.id = id;

    // Upload photo to OneDrive
    if (currentPhotoFile && oneDriveAccount) {
      const url = await uploadPhoto(currentPhotoFile, id);
      if (url) { data.photoURL = url; data.photoBase64 = null; }
    }

    if (currentEditId) {
      const idx = fichas.findIndex(f => f.id === currentEditId);
      if (idx > -1) fichas[idx] = data;
    } else {
      fichas.unshift(data);
    }

    await saveToCloud(data);
    renderFichas();
    updateStats();
    resetForm();
    switchTab('tab-list');
    showToast('‚úÖ Ficha salva com sucesso!', 'success');
  } catch(e) {
    showToast('Erro ao salvar: ' + e.message, 'error');
  }

  btn.disabled = false;
  btn.innerHTML = 'üíæ Salvar Ficha';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CROP EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cropRotation = 0;
let cropOrigImg = null;
let cropBox = { x:0, y:0, w:0, h:0 };
const MIN_CROP = 40;

function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  currentPhotoFile = file;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => { cropOrigImg = img; cropRotation = 0; cropBox = {x:0,y:0,w:0,h:0}; openCropEditor(); };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function openCropEditor() {
  document.getElementById('crop-overlay').classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(drawCropCanvas, 60);
}

function drawCropCanvas() {
  const canvas = document.getElementById('crop-canvas');
  const viewport = document.getElementById('crop-viewport');
  const img = cropOrigImg;
  if (!img) return;
  const rad = cropRotation * Math.PI / 180;
  const rW = Math.abs(img.width*Math.cos(rad)) + Math.abs(img.height*Math.sin(rad));
  const rH = Math.abs(img.width*Math.sin(rad)) + Math.abs(img.height*Math.cos(rad));
  const maxW = viewport.clientWidth - 4;
  const maxH = viewport.clientHeight - 4;
  const sc = Math.min(maxW/rW, maxH/rH, 1);
  canvas.width  = Math.round(rW * sc);
  canvas.height = Math.round(rH * sc);
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.rotate(rad);
  ctx.drawImage(img, -img.width*sc/2, -img.height*sc/2, img.width*sc, img.height*sc);
  ctx.restore();
  if (!cropBox.w) {
    const p = 0.08;
    cropBox = { x: canvas.width*p, y: canvas.height*p, w: canvas.width*(1-p*2), h: canvas.height*(1-p*2) };
  } else {
    cropBox.x = Math.max(0, Math.min(cropBox.x, canvas.width - MIN_CROP));
    cropBox.y = Math.max(0, Math.min(cropBox.y, canvas.height - MIN_CROP));
    cropBox.w = Math.max(MIN_CROP, Math.min(cropBox.w, canvas.width - cropBox.x));
    cropBox.h = Math.max(MIN_CROP, Math.min(cropBox.h, canvas.height - cropBox.y));
  }
  updateCropBoxUI();
}

function updateCropBoxUI() {
  const canvas = document.getElementById('crop-canvas');
  const box    = document.getElementById('crop-box');
  const vr = document.getElementById('crop-viewport').getBoundingClientRect();
  const cr = canvas.getBoundingClientRect();
  box.style.left   = (cr.left - vr.left + cropBox.x) + 'px';
  box.style.top    = (cr.top  - vr.top  + cropBox.y) + 'px';
  box.style.width  = cropBox.w + 'px';
  box.style.height = cropBox.h + 'px';
}

function rotateCrop(deg) {
  cropRotation = (cropRotation + deg + 360) % 360;
  cropBox = {x:0,y:0,w:0,h:0};
  drawCropCanvas();
}

function cancelCrop() {
  document.getElementById('crop-overlay').classList.remove('show');
  document.body.style.overflow = '';
  cropBox = {x:0,y:0,w:0,h:0};
  cropRotation = 0;
  currentPhotoFile = null;
  cropOrigImg = null;
}

function confirmCrop() {
  const canvas = document.getElementById('crop-canvas');
  const img = cropOrigImg;
  if (!img) return;
  const rad = cropRotation * Math.PI / 180;
  const rW = Math.abs(img.width*Math.cos(rad)) + Math.abs(img.height*Math.sin(rad));
  const sc = canvas.width / rW;
  // Build full-res rotated
  const rH = Math.abs(img.width*Math.sin(rad)) + Math.abs(img.height*Math.cos(rad));
  const full = document.createElement('canvas');
  full.width = Math.round(rW); full.height = Math.round(rH);
  const fc = full.getContext('2d');
  fc.save(); fc.translate(full.width/2, full.height/2); fc.rotate(rad);
  fc.drawImage(img, -img.width/2, -img.height/2); fc.restore();
  // Crop
  const cx = cropBox.x/sc, cy = cropBox.y/sc, cw = cropBox.w/sc, ch = cropBox.h/sc;
  const out = document.createElement('canvas');
  const maxOut = 1200;
  const os = Math.min(maxOut/cw, maxOut/ch, 1);
  out.width = Math.round(cw*os); out.height = Math.round(ch*os);
  out.getContext('2d').drawImage(full, cx, cy, cw, ch, 0, 0, out.width, out.height);
  const result = out.toDataURL('image/jpeg', 0.85);
  currentPhotoBase64 = result;
  out.toBlob(blob => { currentPhotoFile = blob; }, 'image/jpeg', 0.85);
  document.getElementById('photo-img').src = result;
  document.getElementById('photo-placeholder').style.display = 'none';
  document.getElementById('photo-preview').style.display = 'block';
  document.getElementById('crop-overlay').classList.remove('show');
  document.body.style.overflow = '';
  cropBox = {x:0,y:0,w:0,h:0};
}

// Drag & resize crop box
(function() {
  let active = null, startPos = null, startBox = null;
  function pos(e) { const t = e.touches?e.touches[0]:e; return {x:t.clientX,y:t.clientY}; }
  function clamp(v,a,b) { return Math.max(a,Math.min(b,v)); }

  function onStart(e) {
    const canvas = document.getElementById('crop-canvas');
    if (!canvas.width) return;
    e.preventDefault();
    startPos = pos(e);
    startBox = {...cropBox};
    active = (e.target.dataset&&e.target.dataset.handle) ? e.target.dataset.handle
           : (e.target.id==='crop-box' ? 'move' : null);
  }

  function onMove(e) {
    if (!active) return;
    e.preventDefault();
    const canvas = document.getElementById('crop-canvas');
    const p = pos(e);
    const dx = p.x - startPos.x, dy = p.y - startPos.y;
    const cw = canvas.width, ch = canvas.height;
    let {x,y,w,h} = startBox;
    if (active === 'move') {
      x = clamp(x+dx, 0, cw-w); y = clamp(y+dy, 0, ch-h);
    } else if (active === 'br') {
      w = clamp(w+dx, MIN_CROP, cw-x); h = clamp(h+dy, MIN_CROP, ch-y);
    } else if (active === 'bl') {
      const nx = clamp(x+dx, 0, x+w-MIN_CROP);
      w = w+(x-nx); x = nx; h = clamp(h+dy, MIN_CROP, ch-y);
    } else if (active === 'tr') {
      w = clamp(w+dx, MIN_CROP, cw-x);
      const ny = clamp(y+dy, 0, y+h-MIN_CROP);
      h = h+(y-ny); y = ny;
    } else if (active === 'tl') {
      const nx = clamp(x+dx, 0, x+w-MIN_CROP);
      const ny = clamp(y+dy, 0, y+h-MIN_CROP);
      w = w+(x-nx); h = h+(y-ny); x = nx; y = ny;
    }
    cropBox = {x,y,w,h};
    updateCropBoxUI();
  }

  function onEnd() { active = null; }

  const cropEl = document.getElementById('crop-box');
  cropEl.addEventListener('mousedown', onStart);
  cropEl.addEventListener('touchstart', onStart, {passive:false});
  cropEl.querySelectorAll('.crop-handle').forEach(h => {
    h.addEventListener('mousedown', onStart);
    h.addEventListener('touchstart', onStart, {passive:false});
  });
  document.addEventListener('mousemove', onMove);
  document.addEventListener('touchmove', onMove, {passive:false});
  document.addEventListener('mouseup', onEnd);
  document.addEventListener('touchend', onEnd);

  window.addEventListener('resize', () => { if (document.getElementById('crop-overlay').classList.contains('show')) drawCropCanvas(); });
})();

function removePhoto(e) {
  if (e) { e.stopPropagation(); e.preventDefault(); }
  currentPhotoFile = null;
  currentPhotoBase64 = null;
  document.getElementById('photo-img').src = '';
  document.getElementById('photo-placeholder').style.display = 'flex';
  document.getElementById('photo-preview').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFichas(list) {
  const data = list || fichas;
  const container = document.getElementById('ficha-list');
  if (data.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìÇ</div><p>Nenhuma ficha encontrada.</p></div>`;
    return;
  }
  container.innerHTML = data.map(f => `
    <div class="ficha-card" onclick="openDetail('${f.id}')">
      <div class="ficha-card-inner">
        <div class="ficha-avatar">${(f.nome||'?').charAt(0).toUpperCase()}</div>
        <div class="ficha-info">
          <h3>${f.nome || 'Sem nome'}</h3>
          <p>${f.localidade || 'Localidade n√£o informada'} ‚Ä¢ ${f.cargos?.length ? f.cargos.slice(0,2).join(', ') : 'Sem cargo'}</p>
        </div>
        <span class="ficha-badge ${f.tipo==='INCLUS√ÉO'?'inclusao':'exclusao'}">${f.tipo||'‚Äî'}</span>
      </div>
    </div>
  `).join('');
}

function filterFichas() {
  const q = document.getElementById('search-input').value.toLowerCase();
  if (!q) { renderFichas(); return; }
  const filtered = fichas.filter(f =>
    (f.nome||'').toLowerCase().includes(q) ||
    (f.localidade||'').toLowerCase().includes(q) ||
    (f.cargos||[]).join(' ').toLowerCase().includes(q)
  );
  renderFichas(filtered);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(id) {
  const f = fichas.find(x => x.id === id);
  if (!f) return;
  document.getElementById('modal-title').textContent = f.nome || 'Ficha';
  const photoHTML = f.photoURL
    ? `<img src="${f.photoURL}" class="modal-photo" alt="Foto da ficha" onclick="openLightbox('${f.photoURL}')" onerror="this.outerHTML='<a href=\\'${f.photoURL}\\' target=\\'_blank\\' style=\\'color:var(--navy);font-weight:600;font-size:13px\\'>üîó Abrir foto no OneDrive</a>'" />`
    : f.photoBase64
    ? `<img src="${f.photoBase64}" class="modal-photo" alt="Foto da ficha" onclick="openLightbox('${f.photoBase64}')" />`
    : '<p style="color:var(--gray-400);font-size:13px">Sem foto</p>';

  document.getElementById('modal-body').innerHTML = `
    <div class="detail-row">
      <span class="detail-label">Nome</span>
      <span class="detail-value">${f.nome || '‚Äî'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Tipo</span>
      <span class="ficha-badge ${f.tipo==='INCLUS√ÉO'?'inclusao':'exclusao'}">${f.tipo || '‚Äî'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Aprovado</span>
      <span class="detail-value">${f.aprovado || '‚Äî'}</span>
    </div>
    ${f.dataReuniao ? `<div class="detail-row"><span class="detail-label">Reuni√£o Ministerial</span><span class="detail-value">${formatDate(f.dataReuniao)}</span></div>` : ''}
    <div class="detail-row">
      <span class="detail-label">Localidade</span>
      <span class="detail-value">${f.localidade || '‚Äî'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Idade / Batismo</span>
      <span class="detail-value">${f.idade ? f.idade + ' anos' : '‚Äî'} / ${f.tempoBatismo || '‚Äî'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Endere√ßo</span>
      <span class="detail-value">${f.endereco || '‚Äî'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Telefone</span>
      <span class="detail-value">${f.telefone || '‚Äî'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Refer√™ncias</span>
      <span class="detail-value">${f.referencias || '‚Äî'}</span>
    </div>
    ${f.cargos?.length ? `
    <div class="detail-row">
      <span class="detail-label">Cargos / Fun√ß√µes</span>
      <div class="detail-tags">${f.cargos.map(c=>`<span class="detail-tag">${c}</span>`).join('')}</div>
    </div>` : ''}
    ${f.outrosDesc ? `<div class="detail-row"><span class="detail-label">Outros</span><span class="detail-value">${f.outrosDesc}</span></div>` : ''}
    ${f.obs ? `<div class="detail-row"><span class="detail-label">Obs</span><span class="detail-value">${f.obs}</span></div>` : ''}
    <div class="detail-row">
      <span class="detail-label">Foto da Ficha</span>
      ${photoHTML}
    </div>
    <button class="btn-secondary" onclick="editFicha('${f.id}')">‚úèÔ∏è Editar</button>
    <button class="btn-danger" onclick="deleteFicha('${f.id}')">üóë Excluir</button>
    <div style="height:16px"></div>
  `;

  document.getElementById('modal-detail').classList.add('show');
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('show');
  document.getElementById('lightbox-img').src = '';
  document.body.style.overflow = '';
}

// Fecha lightbox com ESC
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeLightbox();
});

function closeModal() {
  document.getElementById('modal-detail').classList.remove('show');
}

document.getElementById('modal-detail').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-detail')) closeModal();
});

function editFicha(id) {
  const f = fichas.find(x => x.id === id);
  if (!f) return;
  closeModal();
  currentEditId = id;

  document.getElementById('f-data-reuniao').value = f.dataReuniao || '';
  const r = document.querySelector(`input[name="aprovado"][value="${f.aprovado}"]`);
  if (r) r.checked = true;
  const t = document.querySelector(`input[name="tipo"][value="${f.tipo}"]`);
  if (t) t.checked = true;
  document.getElementById('f-localidade').value = f.localidade || '';
  document.getElementById('f-nome').value = f.nome || '';
  document.getElementById('f-idade').value = f.idade || '';
  document.getElementById('f-tempo-batismo').value = f.tempoBatismo || '';
  document.getElementById('f-endereco').value = f.endereco || '';
  document.getElementById('f-telefone').value = f.telefone || '';
  document.getElementById('f-referencias').value = f.referencias || '';
  document.getElementById('f-obs').value = f.obs || '';
  document.getElementById('f-outros-desc').value = f.outrosDesc || '';

  const map = {
    'Portaria': 'cb-portaria', 'Parte Externa': 'cb-parte-externa', 'Auxiliar De R.J.M': 'cb-auxiliar-rjm',
    'Controle Do Som': 'cb-controle-som', 'Reuniao Evang': 'cb-reuniao-evang',
    'Reuniao Enfermo': 'cb-reuniao-enfermo', 'Fundo Biblico': 'cb-fundo-biblico',
    'Colaborador Admin': 'cb-colaborador-admin', 'Colaborador Piedade': 'cb-colaborador-piedade', 'Outros': 'cb-outros'
  };
  (f.cargos || []).forEach(c => {
    const key = Object.keys(map).find(k => k.toLowerCase() === c.toLowerCase().replace(/\(a\)/g,'').trim());
    if (key) { const el = document.getElementById(map[key]); if(el) el.checked = true; }
  });
  if (f.cargos?.includes('Outros')) document.getElementById('field-outros-desc').style.display = 'block';

  if (f.photoBase64) {
    currentPhotoBase64 = f.photoBase64;
    document.getElementById('photo-img').src = f.photoBase64;
    document.getElementById('photo-placeholder').style.display = 'none';
    document.getElementById('photo-preview').style.display = 'block';
  } else if (f.photoURL) {
    document.getElementById('photo-img').src = f.photoURL;
    document.getElementById('photo-placeholder').style.display = 'none';
    document.getElementById('photo-preview').style.display = 'block';
  }

  switchTab('tab-form');
}

function deleteFicha(id) {
  if (!confirm('Excluir esta ficha?')) return;
  fichas = fichas.filter(f => f.id !== id);
  deleteFromCloud(id);
  renderFichas();
  updateStats();
  closeModal();
  showToast('üóë Ficha exclu√≠da', 'error');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === tab));
  if (tab === 'tab-resumo') updateResumo();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 3000);
}

function formatDate(d) {
  if (!d) return '‚Äî';
  try {
    return new Date(d + 'T12:00:00').toLocaleDateString('pt-BR');
  } catch(e) { return d; }
}

function updateStats() {
  document.getElementById('total-fichas').textContent = fichas.length;
  updateResumo();
}

function updateResumo() {
  const total = fichas.length;
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-inclusao').textContent = fichas.filter(f => f.tipo === 'INCLUS√ÉO').length;
  document.getElementById('r-exclusao').textContent = fichas.filter(f => f.tipo === 'EXCLUS√ÉO').length;
  document.getElementById('r-pendente').textContent = fichas.filter(f => f.aprovado === 'PENDENTE').length;

  const corpo = document.getElementById('resumo-corpo');
  if (total === 0) {
    corpo.innerHTML = '<div class="resumo-empty">Nenhuma ficha cadastrada ainda.<br>V√° em <strong>Nova</strong> para come√ßar.</div>';
    return;
  }

  // Cargo icons map
  const cargoIcons = {
    'portaria': 'üö™', 'parte externa': 'üåø', 'auxiliar de r.j.m': 'üôè',
    'auxiliar rjm': 'üôè', 'controle do som': 'üîä', 'reuniao evang': 'üìñ',
    'reuni√£o de evangeliza√ß√£o': 'üìñ', 'reuniao enfermo': 'üè•',
    'reuni√£o para enfermo': 'üè•', 'fundo biblico': 'üìö',
    'fundo b√≠blico': 'üìö', 'fundo b√≠blico / distribui√ß√£o': 'üìö',
    'colaborador admin': 'üóÇÔ∏è', 'colaborador administra√ß√£o': 'üóÇÔ∏è',
    'colaborador(a) administra√ß√£o': 'üóÇÔ∏è', 'colaborador piedade': 'üíõ',
    'colaborador(a) da piedade': 'üíõ', 'outros': 'üìå'
  };

  function getCargoIcon(cargo) {
    const key = cargo.toLowerCase();
    for (const [k, v] of Object.entries(cargoIcons)) {
      if (key.includes(k)) return v;
    }
    return 'üìå';
  }

  // Count by cargo
  const cargoCounts = {};
  fichas.forEach(f => {
    (f.cargos || []).forEach(c => {
      cargoCounts[c] = (cargoCounts[c] || 0) + 1;
    });
  });
  const sortedCargos = Object.entries(cargoCounts).sort((a,b) => b[1]-a[1]);
  const maxCargo = sortedCargos[0] ? sortedCargos[0][1] : 1;

  // Count by localidade
  const locCounts = {};
  fichas.forEach(f => {
    const loc = f.localidade || 'N√£o informada';
    locCounts[loc] = (locCounts[loc] || 0) + 1;
  });
  const sortedLocs = Object.entries(locCounts).sort((a,b) => b[1]-a[1]);

  let html = '';

  // Section: Cargos
  if (sortedCargos.length > 0) {
    html += `<div class="resumo-section-title">üèõ Fichas por Cargo</div>
    <div class="cargo-list">`;
    sortedCargos.forEach(([cargo, count]) => {
      const pct = Math.round((count / maxCargo) * 100);
      html += `
      <div class="cargo-item">
        <div class="cargo-icon">${getCargoIcon(cargo)}</div>
        <div class="cargo-name">${cargo}</div>
        <div class="cargo-bar-wrap">
          <div class="cargo-bar-bg"><div class="cargo-bar-fill" style="width:${pct}%"></div></div>
        </div>
        <div class="cargo-count">${count}</div>
      </div>`;
    });
    html += `</div>`;
  }

  // Section: Localidades
  if (sortedLocs.length > 0) {
    html += `<div class="resumo-section-title">üìç Fichas por Localidade</div>
    <div class="localidade-list">`;
    sortedLocs.forEach(([loc, count]) => {
      html += `
      <div class="localidade-item">
        <span class="loc-name">üè† ${loc}</span>
        <span class="localidade-badge">${count}</span>
      </div>`;
    });
    html += `</div>`;
  }

  // Section: Aprova√ß√£o
  const aprovSim = fichas.filter(f => f.aprovado === 'SIM').length;
  const aprovNao = fichas.filter(f => f.aprovado === 'N√ÉO').length;
  const aprovPend = fichas.filter(f => f.aprovado === 'PENDENTE').length;

  html += `<div class="resumo-section-title">‚úÖ Status de Aprova√ß√£o</div>
  <div class="aprovacao-list">
    <div class="aprovacao-item">
      <div class="cargo-icon">‚úÖ</div>
      <div class="cargo-name">Aprovados</div>
      <div class="cargo-bar-wrap"><div class="cargo-bar-bg"><div class="cargo-bar-fill" style="width:${total ? Math.round(aprovSim/total*100):0}%;background:linear-gradient(90deg,#27ae60,#2ecc71)"></div></div></div>
      <div class="cargo-count" style="color:var(--success)">${aprovSim}</div>
    </div>
    <div class="aprovacao-item">
      <div class="cargo-icon">‚è≥</div>
      <div class="cargo-name">Pendentes</div>
      <div class="cargo-bar-wrap"><div class="cargo-bar-bg"><div class="cargo-bar-fill" style="width:${total ? Math.round(aprovPend/total*100):0}%;background:linear-gradient(90deg,#e67e22,#f39c12)"></div></div></div>
      <div class="cargo-count" style="color:#e67e22">${aprovPend}</div>
    </div>
    <div class="aprovacao-item">
      <div class="cargo-icon">‚ùå</div>
      <div class="cargo-name">N√£o aprovados</div>
      <div class="cargo-bar-wrap"><div class="cargo-bar-bg"><div class="cargo-bar-fill" style="width:${total ? Math.round(aprovNao/total*100):0}%;background:linear-gradient(90deg,#c0392b,#e74c3c)"></div></div></div>
      <div class="cargo-count" style="color:var(--danger)">${aprovNao}</div>
    </div>
  </div>`;

  // Fichas sem foto
  const semFoto = fichas.filter(f => !f.photoBase64 && !f.photoURL);
  if (semFoto.length > 0) {
    html += `<div class="resumo-section-title" style="margin-top:16px">üì∑ Fichas sem foto <span style="background:#e67e22;color:white;border-radius:20px;padding:2px 10px;font-size:12px;margin-left:6px">${semFoto.length}</span></div>
    <div style="display:flex;flex-direction:column;gap:8px;">`;
    semFoto.forEach(f => {
      html += `
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--white);border:1.5px solid #f39c12;border-radius:var(--radius-sm);padding:10px 14px;cursor:pointer" onclick="editFichaFromResumo('${f.id}')">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="background:linear-gradient(135deg,var(--navy),var(--navy-light));border-radius:50%;color:white;font-size:15px;width:36px;height:36px;line-height:36px;text-align:center;flex-shrink:0">${(f.nome||'?').charAt(0).toUpperCase()}</div>
          <div>
            <div style="font-weight:700;font-size:14px;color:var(--navy)">${f.nome||'Sem nome'}</div>
            <div style="font-size:11px;color:var(--gray-400)">${f.localidade||'‚Äî'} ‚Ä¢ ${f.cargos?.slice(0,1).join(', ')||'Sem cargo'}</div>
          </div>
        </div>
        <span style="font-size:12px;font-weight:700;color:#e67e22;white-space:nowrap">üì∑ Adicionar</span>
      </div>`;
    });
    html += `</div>`;
  }

  html += `<div style="height:20px"></div>`;
  corpo.innerHTML = html;
}

function editFichaFromResumo(id) {
  editFicha(id);
  // After edit loads, scroll to photo section
  setTimeout(() => {
    const photoArea = document.getElementById('photo-placeholder');
    if (photoArea) photoArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG (pr√©-configurado)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_FIREBASE_CONFIG = {
  apiKey: "AIzaSyAStumrNOzBpJIz0SWQR5ymhIrD7vBOcEU",
  authDomain: "cadastro-de-fichas-ccb.firebaseapp.com",
  projectId: "cadastro-de-fichas-ccb",
  storageBucket: "cadastro-de-fichas-ccb.firebasestorage.app",
  messagingSenderId: "959575103518",
  appId: "1:959575103518:web:24998a147ba608c1bf760f"
};

window.addEventListener('load', () => {
  // Limpa sess√£o MSAL de contas erradas do localStorage
  const CONTA_CORRETA = 'secretaria_ccb_caieiras@hotmail.com';
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('msal.') || key.includes('login.windows') || key.includes('microsoftonline')) {
      try {
        const val = localStorage.getItem(key);
        if (val && val.includes('@') && !val.toLowerCase().includes(CONTA_CORRETA.toLowerCase())) {
          localStorage.removeItem(key);
        }
      } catch(e) {}
    }
  });

  loadLocal();
  loadIgrejas();
  renderFichas();
  updateStats();
  renderIgrejas();
  atualizarDatalistIgrejas();

  // Usa config salva pelo usu√°rio ou a config padr√£o embutida
  const savedCfg = loadFirebaseConfig();
  const cfg = savedCfg || DEFAULT_FIREBASE_CONFIG;

  // Salva no localStorage para consist√™ncia
  if (!savedCfg) {
    localStorage.setItem('ccb_fb_config', JSON.stringify(cfg));
  }

  // Preenche os campos de configura√ß√£o na aba Config
  document.getElementById('fb-apiKey').value = cfg.apiKey || '';
  document.getElementById('fb-authDomain').value = cfg.authDomain || '';
  document.getElementById('fb-projectId').value = cfg.projectId || '';
  document.getElementById('fb-storageBucket').value = cfg.storageBucket || '';
  document.getElementById('fb-messagingSenderId').value = cfg.messagingSenderId || '';
  document.getElementById('fb-appId').value = cfg.appId || '';

  // Inicializa Firebase sem autentica√ß√£o obrigat√≥ria
  try {
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    db = firebase.firestore();
    auth = firebase.auth();
  } catch(e) { console.warn('Firebase init:', e); }

  // Carrega config do OneDrive
  const odCfg = loadOneDriveConfig();
  if (odCfg) {
    document.getElementById('od-clientId').value = odCfg.clientId || '';
    document.getElementById('od-redirectUri').value = odCfg.redirectUri || '';
    // Mostra o bot√£o conectar imediatamente se j√° tem config salva
    document.getElementById('btn-od-login').style.display = 'block';
    initMSAL(odCfg).then(() => {
      if (oneDriveAccount) syncFromCloud();
    });
  }

  setTimeout(() => {
    document.getElementById('loader').style.opacity = '0';
    setTimeout(() => document.getElementById('loader').style.display = 'none', 400);
  }, 1200);
});
</script>
</body>
</html>
